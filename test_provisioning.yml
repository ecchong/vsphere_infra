---
- name: Create a VM from a template
  hosts: all
  gather_facts: no
  tasks:
  - name: Clone the template
    vmware_guest:
      hostname: '{{ lookup("env", "VMWARE_HOST") }}'
      username: '{{ lookup("env", "VMWARE_USER") }}'
      password: '{{ lookup("env", "VMWARE_PASSWORD") }}'
      validate_certs: False
      name: '{{vm_name}}'
      template: '{{template_name}}'
      datacenter: '{{datacenter}}
      folder: {{folder}}
      state: poweredon
      cluster: {{cluster}}
      wait_for_ip_address: yes
      networks:
      - name: VM Network
        ip: {{ip_address}}
        netmask: 255.255.255.0
        gateway: {{gateway}}
        domain: {{doamin}}
        dns_servers:
        - {{dns1}}
        - {{dns2}}
      - vlan: {{vlan}}
        type: static
      customization:
        autologon: yes
        dns_servers:
        - {{dns1}}
        - {{dns2}}
        domain: {{domain}}
        password: {{new_password}}
        runonce:
        - powershell.exe -ExecutionPolicy Unrestricted -File C:\Windows\Temp\ConfigureRemotingForAnsible.ps1 -ForceNewSSLCert -EnableCredSSP
    delegate_to: localhost
